<!DOCTYPE html>
<!-- Cache-busting: AI Pong Game -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pong Game - Transcendence</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: white;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-container {
            background: #16213e;
            border: 3px solid #0f0f23;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        canvas {
            background: #0f0f23;
            border: 2px solid #533483;
            display: block;
            margin: 0 auto;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
            flex-direction: row;
        }

        .control-group {
            background: #16213e;
            border: 2px solid #0f0f23;
            border-radius: 8px;
            padding: 15px;
            flex: 0 1 auto;
        }

        .control-group h3 {
            margin: 0 0 10px 0;
            color: #e94560;
        }

        button {
            background: #533483;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        button:hover {
            background: #7209b7;
        }

        button:active {
            background: #a663cc;
        }

        button:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .difficulty-btn {
            position: relative;
            min-width: 80px;
            transition: all 0.3s ease;
        }

        .difficulty-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px currentColor;
        }

        .difficulty-btn.easy { color: #10b981; }
        .difficulty-btn.medium { color: #f59e0b; }
        .difficulty-btn.hard { color: #ef4444; }
        .difficulty-btn.expert { color: #7c3aed; }

        .status {
            background: #16213e;
            border: 2px solid #0f0f23;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            width: 800px;
            max-width: 90vw;
        }

        .score {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            color: #e94560;
        }

        .difficulty-info {
            background: #0f0f23;
            border: 1px solid #533483;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .difficulty-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .difficulty-description {
            font-size: 14px;
            opacity: 0.8;
        }

        .game-log {
            background: #0f0f23;
            border: 1px solid #533483;
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            font-size: 12px;
            white-space: pre-wrap;
            margin: 10px 0;
        }

        .game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            text-align: center;
        }

        .game-overlay.hidden {
            display: none;
        }

        .game-overlay button {
            margin: 10px;
            font-size: 18px;
        }

        .instructions {
            background: #16213e;
            border: 2px solid #0f0f23;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            width: 800px;
            max-width: 90vw;
        }

        .instructions h3 {
            color: #e94560;
            margin-top: 0;
        }

        .instructions ul {
            text-align: left;
            line-height: 1.6;
        }
        /* Main Navigation Styles */
        .main-nav {
            background: linear-gradient(135deg, #ff6b9d, #c44569, #f8b500, #6c5ce7);
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .main-nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .main-nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .main-nav-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .main-nav-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .main-nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
            margin: 0;
            padding: 0;
        }

        .main-nav-link {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .main-nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .main-nav-link.home:hover { background: rgba(255, 107, 157, 0.3); }
        .main-nav-link.friends:hover { background: rgba(196, 69, 105, 0.3); }
        .main-nav-link.analytics:hover { background: rgba(248, 181, 0, 0.3); }
        .main-nav-link.profile:hover { background: rgba(108, 92, 231, 0.3); }
        .main-nav-link.logout:hover { background: rgba(255, 107, 157, 0.3); }
    </style>
</head>
<body>
    <!-- Main Website Navigation -->
    <nav class="main-nav">
        <div class="main-nav-content">
            <div class="main-nav-brand">
                <img src="/imgs/logo.png" alt="Powerpuff Girls Logo" class="main-nav-logo">
                <span class="main-nav-title">Powerpuff Pong</span>
            </div>
            <ul class="main-nav-links">
                <li><a href="/" class="main-nav-link home">Home</a></li>
                <li><a href="/" class="main-nav-link friends">Friends</a></li>
                <li><a href="/dashboard.html" class="main-nav-link analytics">Dashboard</a></li>
                <li><a href="/" class="main-nav-link profile">Profile</a></li>
                <li><a href="/" class="main-nav-link logout">Logout</a></li>
            </ul>
        </div>
    </nav>

    <h1>ü§ñ AI Pong Game</h1>

    <div class="instructions">
        <h3>How to Play:</h3>
        <ul>
            <li><strong>Controls:</strong> Use <strong>W</strong> (up) and <strong>S</strong> (down) keys to move your paddle</li>
            <li><strong>Objective:</strong> Beat the AI! First to 5 points wins</li>
            <li><strong>AI Difficulty:</strong> Choose your challenge level below</li>
            <li><strong>Scoring:</strong> Score when the AI misses the ball, lose when you miss</li>
        </ul>
    </div>

    <div class="game-container">
        <div class="score" id="scoreDisplay">Player: 0 - AI: 0</div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <!-- Game Over Overlay -->
        <div class="game-overlay hidden" id="gameOverlay">
            <div id="gameOverMessage">Game Over!</div>
            <button id="replayBtn">üîÑ Play Again</button>
            <button id="backBtn">üè† Back to Menu</button>
        </div>
    </div>

    <div class="controls">
        <!-- Connection controls must come first -->
        <div class="control-group" style="order: 1;">
            <h3>Connection</h3>
            <button id="connectBtn">üîå Connect</button>
            <button id="disconnectBtn" disabled>‚ùå Disconnect</button>
        </div>
        
        <!-- Difficulty selection -->
        <div class="control-group" style="order: 2;">
            <h3>AI Difficulty</h3>
            <button id="easyBtn" class="difficulty-btn easy">üü¢ Easy</button>
            <button id="mediumBtn" class="difficulty-btn medium active">üü† Medium</button>
            <button id="hardBtn" class="difficulty-btn hard">üî¥ Hard</button>
            <button id="expertBtn" class="difficulty-btn expert">üü£ Expert</button>
        </div>
        
        <!-- Game controls come after connection -->
        <div class="control-group" style="order: 3;">
            <h3>Game Controls</h3>
            <button id="startBtn">‚ñ∂Ô∏è Start Game</button>
            <button id="pauseBtn" disabled>‚è∏Ô∏è Pause</button>
            <button id="restartBtn" disabled>üîÑ Restart</button>
        </div>
    </div>

    <div class="status">
        <h3>Current Difficulty</h3>
        <div class="difficulty-info" id="difficultyInfo">
            <div class="difficulty-name">Medium</div>
            <div class="difficulty-description">Balanced AI performance</div>
        </div>
    </div>

    <div class="status">
        <h3>Game Status</h3>
        <div id="connectionStatus">Disconnected</div>
        <div id="gameStatus">Ready to play</div>
    </div>

    <div class="status">
        <h3>Game Log</h3>
        <div class="game-log" id="gameLog"></div>
    </div>

    <script>
        // Game configuration constants - matches backend configuration
        const GAME_CONFIG = {
            CANVAS: {
                WIDTH: 800,
                HEIGHT: 600
            },
            PADDLE: {
                WIDTH: 15,
                HEIGHT: 100,
                SPEED: 4
            },
            BALL: {
                RADIUS: 10,
                SPEED_X: 5,
                SPEED_Y: 3
            },
            GAME: {
                WINNING_SCORE: 5
            }
        };

        // Game variables
        let ws = null;
        let gameState = {
            ballX: GAME_CONFIG.CANVAS.WIDTH / 2,
            ballY: GAME_CONFIG.CANVAS.HEIGHT / 2,
            ballSpeedX: GAME_CONFIG.BALL.SPEED_X,
            ballSpeedY: GAME_CONFIG.BALL.SPEED_Y,
            ballRadius: GAME_CONFIG.BALL.RADIUS,
            playerPaddleY: (GAME_CONFIG.CANVAS.HEIGHT - GAME_CONFIG.PADDLE.HEIGHT) / 2,
            aiPaddleY: (GAME_CONFIG.CANVAS.HEIGHT - GAME_CONFIG.PADDLE.HEIGHT) / 2,
            playerScore: 0,
            aiScore: 0,
            gameStarted: false,
            gameOver: false,
            winningScore: GAME_CONFIG.GAME.WINNING_SCORE,
            currentDifficulty: 'MEDIUM'
        };

        let keys = { w: false, s: false };
        let animationId = null;
        let availableDifficulties = {};

        // DOM elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const restartBtn = document.getElementById('restartBtn');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const connectionStatus = document.getElementById('connectionStatus');
        const gameStatus = document.getElementById('gameStatus');
        const gameLog = document.getElementById('gameLog');
        const gameOverlay = document.getElementById('gameOverlay');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const difficultyInfo = document.getElementById('difficultyInfo');

        // Difficulty buttons
        const easyBtn = document.getElementById('easyBtn');
        const mediumBtn = document.getElementById('mediumBtn');
        const hardBtn = document.getElementById('hardBtn');
        const expertBtn = document.getElementById('expertBtn');

        // Logging function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            gameLog.textContent += `[${timestamp}] ${message}\n`;
            gameLog.scrollTop = gameLog.scrollHeight;
            console.log(message);
        }

        // Update score display
        function updateScore() {
            scoreDisplay.textContent = `Player: ${gameState.playerScore} - AI: ${gameState.aiScore}`;
        }

        // Update difficulty display
        function updateDifficultyDisplay(difficulty, aiConfig) {
            const difficultyName = document.querySelector('.difficulty-name');
            const difficultyDescription = document.querySelector('.difficulty-description');
            
            difficultyName.textContent = aiConfig.name;
            difficultyDescription.textContent = aiConfig.description;
            
            // Update active button
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${difficulty.toLowerCase()}Btn`).classList.add('active');
        }

        // Change difficulty
        function changeDifficulty(difficulty) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'change-difficulty', difficulty: difficulty }));
                log(`Changing difficulty to ${difficulty}...`);
            }
        }

        // Draw game elements
        function drawGame() {
            // Clear canvas
            ctx.fillStyle = '#0f0f23';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw center line
            ctx.strokeStyle = '#533483';
            ctx.setLineDash([5, 15]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw player paddle (left)
            ctx.fillStyle = '#60a5fa';
            ctx.fillRect(GAME_CONFIG.PADDLE.WIDTH, gameState.playerPaddleY, GAME_CONFIG.PADDLE.WIDTH, GAME_CONFIG.PADDLE.HEIGHT);

            // Draw AI paddle (right) with difficulty-based color
            const aiColor = availableDifficulties[gameState.currentDifficulty]?.color || '#f87171';
            ctx.fillStyle = aiColor;
            ctx.fillRect(GAME_CONFIG.CANVAS.WIDTH - GAME_CONFIG.PADDLE.WIDTH * 2, gameState.aiPaddleY, GAME_CONFIG.PADDLE.WIDTH, GAME_CONFIG.PADDLE.HEIGHT);

            // Draw ball
            ctx.fillStyle = '#facc15';
            ctx.beginPath();
            ctx.arc(gameState.ballX, gameState.ballY, gameState.ballRadius, 0, Math.PI * 2);
            ctx.fill();
        }

        // Game loop
        function gameLoop() {
            drawGame();
            animationId = requestAnimationFrame(gameLoop);
        }

        // Start game loop
        function startGameLoop() {
            if (!animationId) {
                gameLoop();
            }
        }

        // Stop game loop
        function stopGameLoop() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }

        // Connect to AI game WebSocket
        function connect() {
            try {
                ws = new WebSocket('wss://localhost/ai-game');
                
                ws.onopen = () => {
                    log('Connected to AI Pong Game!');
                    connectionStatus.textContent = 'Connected';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    startBtn.disabled = false;
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        switch (data.type) {
                            case 'connected':
                                log(data.message);
                                break;
                                
                            case 'game-state':
                                gameState = { ...gameState, ...data.gameState };
                                if (data.availableDifficulties) {
                                    availableDifficulties = data.availableDifficulties.reduce((acc, diff) => {
                                        acc[diff.key] = diff;
                                        return acc;
                                    }, {});
                                }
                                updateScore();
                                if (gameState.currentDifficulty && availableDifficulties[gameState.currentDifficulty]) {
                                    updateDifficultyDisplay(gameState.currentDifficulty, availableDifficulties[gameState.currentDifficulty]);
                                }
                                break;
                                
                            case 'difficulty-changed':
                                gameState.currentDifficulty = data.difficulty;
                                updateDifficultyDisplay(data.difficulty, data.aiConfig);
                                log(data.message);
                                break;
                                
                            case 'game-started':
                                log(data.message);
                                gameStatus.textContent = 'Game Running';
                                startBtn.disabled = true;
                                pauseBtn.disabled = false;
                                pauseBtn.textContent = '‚è∏Ô∏è Pause';
                                restartBtn.disabled = false;
                                startGameLoop();
                                break;
                                
                            case 'game-update':
                                gameState = { ...gameState, ...data.gameState };
                                updateScore();
                                break;
                                
                            case 'game-paused':
                                log(data.message);
                                gameStatus.textContent = 'Game Paused';
                                pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
                                stopGameLoop();
                                break;
                                
                            case 'game-resumed':
                                log(data.message);
                                gameStatus.textContent = 'Game Running';
                                pauseBtn.textContent = '‚è∏Ô∏è Pause';
                                startGameLoop();
                                break;
                                
                            case 'game-over':
                                log(`Game Over! ${data.winner === 'player' ? 'You win!' : 'AI wins!'} (Difficulty: ${data.difficulty})`);
                                gameStatus.textContent = 'Game Over';
                                gameOverMessage.textContent = data.winner === 'player' ? 
                                    'üèÜ Victory! You Beat the AI!' : 'ü§ñ Game Over! AI Wins!';
                                gameOverlay.classList.remove('hidden');
                                stopGameLoop();
                                startBtn.disabled = false;
                                pauseBtn.disabled = true;
                                pauseBtn.textContent = '‚è∏Ô∏è Pause';
                                restartBtn.disabled = false;
                                
                                // Game result is automatically saved by the backend WebSocket
                                log('Game result will be saved automatically');
                                break;
                                
                            case 'error':
                                log(`Error: ${data.message}`);
                                break;
                                
                            default:
                                log(`Received: ${data.type}`);
                        }
                    } catch (e) {
                        log(`Error parsing message: ${e.message}`);
                    }
                };

                ws.onclose = (event) => {
                    log(`Connection closed: ${event.reason || 'No reason provided'}`);
                    connectionStatus.textContent = 'Disconnected';
                    gameStatus.textContent = 'Connection lost';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    startBtn.disabled = true;
                    pauseBtn.disabled = true;
                    pauseBtn.textContent = '‚è∏Ô∏è Pause';
                    restartBtn.disabled = true;
                    stopGameLoop();
                    ws = null;
                };

                ws.onerror = (error) => {
                    log('WebSocket error occurred');
                    connectionStatus.textContent = 'Error';
                    console.error('WebSocket error:', error);
                };

            } catch (error) {
                log(`Failed to create WebSocket: ${error.message}`);
                connectionStatus.textContent = 'Error';
            }
        }

        // Disconnect from WebSocket
        function disconnect() {
            if (ws) {
                ws.close(1000, 'Manual disconnect');
                log('Disconnecting...');
            }
        }

        // Send start game command
        function startGame() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'start-game' }));
                log('Starting game...');
            }
        }

        // Send pause game command
        function pauseGame() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'pause-game' }));
            }
        }

        // Send restart game command
        function restartGame() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'restart-game' }));
                log('Restarting game...');
            }
        }



        // Event listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        startBtn.addEventListener('click', startGame);
        pauseBtn.addEventListener('click', pauseGame);
        restartBtn.addEventListener('click', restartGame);

        // Difficulty button event listeners
        easyBtn.addEventListener('click', () => changeDifficulty('EASY'));
        mediumBtn.addEventListener('click', () => changeDifficulty('MEDIUM'));
        hardBtn.addEventListener('click', () => changeDifficulty('HARD'));
        expertBtn.addEventListener('click', () => changeDifficulty('EXPERT'));

        // Game overlay buttons
        document.getElementById('replayBtn').addEventListener('click', () => {
            gameOverlay.classList.add('hidden');
            restartGame();
        });

        document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = '/';
        });

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'w') keys.w = true;
            if (e.key === 's') keys.s = true;
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'w') keys.w = false;
            if (e.key === 's') keys.s = false;
        });

        // Player paddle movement
        function updatePlayerPaddle() {
            if (keys.w && gameState.playerPaddleY > 0) {
                gameState.playerPaddleY -= GAME_CONFIG.PADDLE.SPEED;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'player-input', action: 'up' }));
                }
            }
            if (keys.s && gameState.playerPaddleY < GAME_CONFIG.CANVAS.HEIGHT - GAME_CONFIG.PADDLE.HEIGHT) {
                gameState.playerPaddleY += GAME_CONFIG.PADDLE.SPEED;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'player-input', action: 'down' }));
                }
            }
        }

        // Player control loop
        function playerControlLoop() {
            updatePlayerPaddle();
            requestAnimationFrame(playerControlLoop);
        }

        // Initialize
        updateScore();
        drawGame();
        playerControlLoop();

        log('AI Pong Game loaded with enhanced professional standards!');
        log('Click Connect to start playing against the AI!');
        log('Use W and S keys to control your paddle.');
        log('Select your preferred AI difficulty level!');
        console.log('üéÆ AI Pong Game HTML loaded successfully!');

        // Setup main website navigation
        function setupMainNavigation() {
            const navLinks = document.querySelectorAll('.main-nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    const linkClass = link.classList[1];

                    if (href === '/ai-pong.html') {
                        return; // Already on AI pong page
                    }

                    if (href === '/dashboard.html') {
                        window.location.href = '/dashboard.html';
                        return;
                    }

                    if (href === '/') {
                        if (linkClass === 'home') {
                            window.location.href = '/';
                        } else if (linkClass === 'friends') {
                            window.location.href = '/?section=friends';
                        } else if (linkClass === 'profile') {
                            window.location.href = '/?section=profile';
                        } else if (linkClass === 'logout') {
                            handleLogout();
                        }
                    }
                });
            });
        }

        // Handle logout functionality
        function handleLogout() {
            document.cookie = 'authToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            localStorage.removeItem('userData');
            localStorage.removeItem('authToken');
            window.location.href = '/';
        }

        // Initialize navigation when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setupMainNavigation();
        });
    </script>
</body>
</html>
